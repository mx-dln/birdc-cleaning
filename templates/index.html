<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Data Cleaner • Studio</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- jQuery + DataTables + Bootstrap 5 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" />
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Lottie Animation -->
  <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.11/dist/dotlottie-wc.js" type="module"></script>

  <!-- Icons (Bootstrap Icons) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    :root {
      --primary: #6366f1;
      --primary-soft: #eef2ff;
      --bg: #f3f4f6;
      --bg-elevated: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --success: #10b981;
      --danger: #ef4444;
      --radius-lg: 14px;
      --radius: 10px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
    }

    /* Layout */
    .app-shell {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 250px;
      background: #111827;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      padding: 20px 16px;
    }

    .sidebar-brand {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      padding: 0 4px;
    }

    .sidebar-brand-logo {
      width: 100%;
      max-width: 200px;
      height: auto;
      display: block;
      background-color: white;
      border-radius: 12px;
      padding: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .sidebar-nav {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1;
    }

    .sidebar-nav li {
      margin-bottom: 4px;
    }

    .sidebar-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      color: #d1d5db;
      text-decoration: none;
      transition: background 0.16s, color 0.16s, transform 0.08s;
    }

    .sidebar-link i {
      font-size: 16px;
    }

    .sidebar-link:hover {
      background: rgba(55, 65, 81, 0.85);
      color: #ffffff;
      transform: translateY(-1px);
    }

    .sidebar-link.active {
      background: linear-gradient(90deg, rgba(99, 102, 241, 0.1), rgba(22, 163, 74, 0.18));
      color: #ffffff;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .sidebar-footer {
      font-size: 11px;
      color: #6b7280;
      margin-top: 12px;
      border-top: 1px solid #1f2933;
      padding-top: 8px;
    }

    .sidebar-footer span {
      display: block;
    }

    /* Main content */
    .main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: white;
      position: sticky;
      top: 0;
      z-index: 1001;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .topbar-logo {
      display: flex;
      align-items: center;
    }

    .topbar-brand-logo {
      height: 32px;
      width: auto;
      object-fit: contain;
    }

    .topbar-center {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .topbar-nav {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .topbar-link {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 8px;
      text-decoration: none;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .topbar-link:hover {
      background: var(--primary-soft);
      color: var(--primary);
    }

    .topbar-link.active {
      background: var(--primary);
      color: white;
    }

    .topbar-link i {
      font-size: 14px;
    }

    .topbar-title {
      font-weight: 600;
      font-size: 18px;
    }

    .topbar-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill-badge {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: #4f46e5;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }

    .content-wrap {
      padding: 20px 24px 28px;
      min-width: 0;
    }

    /* Cards & sections */
    .card-pro {
      background: var(--bg-elevated);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(229, 231, 235, 0.92);
      padding: 18px 18px 16px;
      margin-bottom: 18px;
    }

    .card-header-pro {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .card-header-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .card-title-pro {
      font-weight: 600;
      font-size: 15px;
    }

    .card-subtitle-pro {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Dropzone */
    .dropzone {
      border: 1px dashed rgba(99, 102, 241, 0.4);
      background: radial-gradient(circle at top left, rgba(129, 140, 248, 0.13), transparent 46%);
      padding: 28px 22px;
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: border 0.2s, background 0.2s, transform 0.08s;
      position: relative;
      overflow: hidden;
    }

    .dropzone:hover {
      border-color: rgba(79, 70, 229, 0.8);
      background: radial-gradient(circle at top left, rgba(129, 140, 248, 0.18), transparent 52%);
      transform: translateY(-1px);
    }

    .dropzone-icon {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: rgba(79, 70, 229, 0.09);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 8px;
      font-size: 22px;
      color: #4f46e5;
    }

    .dropzone-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .dropzone-subtext {
      font-size: 12px;
      color: var(--text-muted);
    }

    .dropzone input {
      display: none;
    }

    .file-name {
      margin-top: 8px;
      font-size: 12px;
      font-weight: 500;
      color: #1f2933;
    }

    /* Button styles */
    .btn-ghost {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-size: 12px;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-ghost i {
      font-size: 14px;
    }

    .btn-ghost:hover {
      background: #f9fafb;
    }

    .btn-soft {
      border-radius: 999px;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 12px;
      padding: 8px 14px;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      box-shadow: 0 10px 24px rgba(79, 70, 229, 0.28);
    }

    .btn-soft:hover {
      background: #4f46e5;
      color: white;
    }

    .beta-label {
      background-color: #f97316;
      color: white;
      font-size: 0.6rem;
      padding: 2px 6px;
      margin-left: 4px;
      border-radius: 999px;
      vertical-align: middle;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .btn-icon {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      padding: 0;
    }

    .btn-icon:hover {
      background: #f3f4f6;
    }

    /* Tool groups */
    .help-circle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: #6366f1;
      color: white;
      font-size: 10px;
      font-weight: bold;
      margin-left: 6px;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
    }

    .help-circle:hover {
      background-color: #4f46e5;
      transform: scale(1.1);
    }

    .help-tooltip {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #1f2937;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 10px;
      white-space: nowrap;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      margin-top: 5px;
      max-width: 200px;
      white-space: normal;
      line-height: 1.3;
    }

    .help-tooltip::after {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 4px solid transparent;
      border-bottom-color: #1f2937;
    }

    .help-circle:hover .help-tooltip {
      opacity: 1;
      visibility: visible;
    }

    .tool-group-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .tool-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tool-chip {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      padding: 7px 12px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.16s, border-color 0.16s, transform 0.06s;
    }

    .tool-chip i {
      font-size: 14px;
    }

    .tool-chip:hover {
      background: #eef2ff;
      border-color: rgba(79, 70, 229, 0.6);
      transform: translateY(-1px);
    }

    .tool-chip.danger:hover {
      background: #fef2f2;
      border-color: #fecaca;
    }

    .tool-chip.success:hover {
      background: #ecfdf5;
      border-color: #a7f3d0;
    }

    /* Inputs row */
    .mini-input {
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      height: 32px;
    }

    .mini-select {
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      height: 32px;
    }

    /* Data area */
    #output {
      margin-top: 4px;
      background: #f9fafb;
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      overflow-x: auto;
    }

    table.dataframe {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    table.dataframe th,
    table.dataframe td {
      padding: 8px;
      border: 1px solid var(--border);
      text-align: left;
    }

    table.dataframe th {
      background-color: #eef2ff;
      font-size: 12px;
    }

    /* Edit Button Styles */
    .edit-btn {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    tr:hover .edit-btn {
      opacity: 1;
    }
    
    .edit-btn:hover {
      background-color: #6366f1 !important;
      border-color: #6366f1 !important;
      color: white !important;
    }

    /* Chart area */
    #chart img {
      width: 100%;
      margin-top: 10px;
      border-radius: var(--radius);
    }

    /* Loader overlay */
    #loader {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(249, 250, 251, 0.85);
      z-index: 9999;
      text-align: center;
      padding-top: 200px;
      font-size: 18px;
      font-weight: 500;
      color: var(--primary);
      backdrop-filter: blur(4px);
    }

    /* Data profile modal (custom) */
    #dataProfileModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(15, 23, 42, 0.55);
      z-index: 1000;
    }

    #dataProfileModal .modal-content {
      background: white;
      padding: 20px;
      border-radius: 14px;
      max-width: 900px;
      margin: 4% auto;
      position: relative;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: var(--shadow-soft);
    }

    #dataProfileModal .modal-content span {
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 24px;
      cursor: pointer;
      color: #9ca3af;
    }

    /* Mapping & barangay sidebars */
    .mapping-sidebar {
      position: fixed;
      top: 0;
      right: -420px;
      width: 400px;
      height: 100vh;
      background: white;
      overflow-y: auto;
      border-left: 1px solid #e5e7eb;
      box-shadow: -2px 0 18px rgba(15, 23, 42, 0.2);
      transition: right 0.3s ease;
      z-index: 9999;
    }

    .mapping-sidebar.open {
      right: 0;
    }

    .sidebar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: #f9fafb;
  padding: 10px 14px;
  border-bottom: 1px solid #e5e7eb;
  position: sticky;
  top: 0;
  z-index: 1;
  font-size: 13px;
  font-weight: 500;
}

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #f9fafb;
      padding: 10px 14px;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: 13px;
      font-weight: 500;
    }

    .sidebar-header button {
      font-size: 18px;
      border-radius: 999px;
      border: none;
      background: transparent;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .sidebar-header button:hover {
      background: #e5e7eb;
    }

    .cleaning-tabs {
      display: flex;
      flex-direction: column;
      border-right: 1px solid #e5e7eb;
      width: 200px;
      min-width: 200px;
      background: #f9fafb;
    }

    .cleaning-tabs button {
      text-align: left;
      padding: 0.75rem 1.5rem;
      border: none;
      background: none;
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: all 0.2s;
    }

    .cleaning-tabs button:hover {
      background: #f3f4f6;
    }

    .cleaning-tabs button.active {
      background: white;
      border-left-color: var(--primary);
      font-weight: 500;
      color: var(--primary);
    }

    body.sidebar-open .content-wrap {
      margin-right: 420px;
      transition: margin-right 0.3s ease;
    }

    /* Unaligned modal inside barangay sidebar */
    .modal {
      display: none;
      position: fixed;
      z-index: 1100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-height: 80%;
      overflow-y: auto;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .close-btn {
      color: white;
      background: var(--danger);
      border: none;
      padding: 5px 10px;
      font-size: 16px;
      border-radius: 999px;
      cursor: pointer;
      position: absolute;
      top: 10px;
      right: 10px;
    }

    /* Magic button sparkles */
    .magic-button {
      position: relative;
      overflow: hidden;
      background-color: var(--success);
      color: white;
      border: none;
      padding: 8px 15px;
      font-size: 12px;
      cursor: pointer;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      z-index: 1;
      box-shadow: 0 10px 24px rgba(16, 185, 129, 0.3);
    }

    .sparkle-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .sparkle {
      position: absolute;
      color: #fff;
      font-size: 16px;
      animation: sparkleMove 4s linear forwards;
      opacity: 0;
    }

    @keyframes sparkleMove {
      0% {
        transform: scale(0.8) translateY(0);
        opacity: 0;
      }

      10% {
        opacity: 1;
      }

      90% {
        transform: scale(1.5) translateY(-80px) rotate(30deg);
        opacity: 1;
      }

      100% {
        transform: scale(0.5) translateY(-100px) rotate(60deg);
        opacity: 0;
      }
    }

    /* Tabbed interface */
    .tab-content {
      display: none;
      padding: 1.5rem;
      flex: 1;
      overflow-y: auto;
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
    }

    .operations-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .tab-content-wrapper {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }

    .content-wrap {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      background-color: var(--bg);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 60px);
      /* Adjust based on your header height */
    }

    .card-pro {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      margin-bottom: 1.5rem;
      overflow: hidden;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .card-pro .card-body {
      flex: 1;
      overflow: auto;
    }

    /* Operations Container */
    .operations-container {
      display: flex;
      flex: 1;
      min-height: 0;
      /* Fix for Firefox */
      position: relative;
      overflow: hidden;
      gap: 0;
      /* Remove gap between main content and sidebar */
    }

    /* Data Preview */
    .card-pro {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      /* Fix for flexbox overflow */
      margin-right: 0;
      /* No margin needed with fixed tabs */
      background: #fff;
      border-radius: 8px 0 0 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .card-pro.tab-open {
      margin-right: 0;
      /* No margin needed with fixed tabs */
    }

    .card-pro .card-body {
      flex: 1;
      overflow: auto;
      padding: 1.5rem;
    }

    /* Operations Sidebar */
    .operations-sidebar {
      display: flex;
      flex-direction: row;
      width: auto;
      height: 100%;
      background: white;
      border-left: 1px solid #e2e8f0;
      z-index: 10;
      position: relative;
    }

    
    .operations-sidebar .card-pro {
      margin-right: 0;
      border-radius: 0;
      box-shadow: none;
      height: 100%;
    }

    .operations-tabs-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Vertical Tabs - Fixed positioning */
    .vertical-tabs {
      width: 30px;
      min-width: 60px;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
      border-left: 1px solid #e2e8f0;
      position: fixed;
      right: 0;
      top: 60px;
      bottom: 0;
      z-index: 1001;
      height: calc(100vh - 60px);
    }

    .vertical-tabs .tab-button {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 0;
      border: none;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      color: #64748b;
      font-size: 0.7rem;
      font-weight: 600;
      border-left: 3px solid transparent;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      margin: 1px 0;
      border-radius: 0 8px 8px 0;
      flex-direction: column;
      height: calc(25% - 2px);
      width: 100%;
      border-bottom: none;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      position: relative;
      overflow: hidden;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .vertical-tabs .tab-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, transparent 0%, rgba(99, 102, 241, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .vertical-tabs .tab-button:hover {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      color: #1e293b;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-left-color: #6366f1;
    }

    .vertical-tabs .tab-button:hover::before {
      opacity: 1;
    }

    .vertical-tabs .tab-button i {
      display: none;
      /* Hide icons for vertical text */
    }


    .vertical-tabs .tab-button.active {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-left: 3px solid #6366f1;
      color: #6366f1;
      font-weight: 700;
      position: relative;
      border-right: 2px solid #ffffff;
      box-shadow: 0 4px 16px rgba(99, 102, 241, 0.2);
      z-index: 10;
    }

    .vertical-tabs .tab-button.active::after {
      content: '';
      position: absolute;
      top: 50%;
      left: -8px;
      width: 6px;
      height: 6px;
      background: #6366f1;
      border-radius: 50%;
      transform: translateY(-50%);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
    }

    .vertical-tabs .tab-button.active i {
      display: none;
      /* Hide icons for vertical text */
    }


    /* Tab Content */
    .tab-content {
      position: fixed;
      right: 60px;
      /* Adjusted for fixed tabs */
      top: 60px;
      bottom: 0;
      display: none;
      flex-direction: column;
      overflow-y: auto;
      padding: 2rem;
      background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
      width: 320px;
      min-width: 320px;
      border-left: 1px solid #e2e8f0;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.08);
      border-radius: 16px 0 0 16px;
      backdrop-filter: blur(10px);
      z-index: 1000;
      height: calc(100vh - 60px);
    }

    .tab-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
      border-radius: 16px 0 0 0;
    }

    .tab-content.active {
      display: flex;
      animation: slideIn 0.2s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(20px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    .tab-content.active {
      display: flex;
    }

    /* Row selection for bulk delete */
    .dataframe tbody tr {
      user-select: none;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .dataframe tbody tr:hover {
      background-color: #f8fafc;
    }
    
    .dataframe tbody tr.selected {
      background-color: #fee2e2;
      border: 2px solid #dc2626;
    }
    
    .dataframe tbody tr.selecting {
      background-color: #fef3c7;
    }
    
    .selection-info {
      position: fixed;
      top: 80px;
      right: 20px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: none;
    }

    /* Responsive tweaks */
    @media (max-width: 1200px) {
      .operations-sidebar {
        position: relative;
      }

      .tab-content {
        width: 250px;
        min-width: 250px;
      }
    }

    @media (max-width: 992px) {
      .sidebar {
        display: none;
      }

      .content-wrap {
        padding: 16px 14px 22px;
      }

      .topbar {
        padding: 0 14px;
      }
    }

    @media (max-width: 576px) {
      .card-header-pro {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }

      .tool-chip-row {
        gap: 6px;
      }
    }
  </style>
</head>

<body>
  <div id="loader"> Processing data…</div>

  <div class="app-shell">
    <!-- Main area -->
    <div class="main-area">
      <!-- Topbar -->
      <header class="topbar">
        <div class="topbar-left">
          <div class="topbar-logo">
            <img src="/static/BG.png" alt="Data Cleaner Studio" class="topbar-brand-logo">
          </div>
          <nav class="topbar-nav">
            <a href="#" class="topbar-link active"><i class="bi bi-grid-1x2-fill"></i><span>Workspace</span></a>
            <a href="#" class="topbar-link" onclick="toggleImportModal()"><i class="bi bi-upload"></i><span>Import
                Data</span></a>
            <a href="#" class="topbar-link" onclick="toggleTutorialSidebar()"><i
                class="bi bi-question-circle"></i><span>Tutorial</span></a>
            <a href="#" class="topbar-link" onclick="callAction('magic_clean')"><i class="bi bi-stars"></i><span>Magic
                Clean</span></a>
          </nav>
        </div>
        <div class="topbar-center">
        </div>
        <div class="topbar-right">
          <button class="btn-ghost" onclick="showAboutModal()" title="About App">
            <i class="bi bi-info-circle"></i> About
          </button>
                    <button class="btn-ghost" style="background-color: #10b981; color: white;" onclick="exportCSV()">
            <i class="bi bi-download"></i> Export CSV
          </button>
          <div class="user-avatar">
            <i class="bi bi-robot"></i>
          </div>
        </div>
      </header>

      <!-- Content -->
      <main class="content-wrap">
        <div class="operations-container">
          <!-- Data Preview (Full Width) -->
          <div class="card-pro" style="flex: 1; margin-right: 0;">
            <div class="card-header-pro">
              <div class="card-header-main">
                <h5 class="mb-0">Data Preview <span style="font-size: 12px; color: #666;">v6.0.1</span></h5>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn-ghost btn-sm" onclick="reloadData()" id="refreshBtn" style="display: none;" title="Refresh Data">
                  <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button class="btn-ghost btn-sm" onclick="undoReplace()" id="undoBtn" style="display: none;" title="Undo Last Operation">
                  <i class="bi bi-arrow-counterclockwise"></i> Undo
                </button>
                <button class="btn-ghost btn-sm" onclick="unselectAllRows()" id="cancelBtn" style="display: none;" title="Unselect All">
                  <i class="bi bi-x-square"></i> Cancel
                </button>
                <button class="btn-ghost btn-sm" onclick="bulkDeleteRows()" id="bulkDeleteBtn" style="display: none; background-color: #dc2626; color: white;">
                  <i class="bi bi-trash"></i> Delete Selected (<span id="selectedCount">0</span>)
                </button>
              </div>
            </div>
            <div class="card-body" style="overflow: auto;">
              <div id="output">
                <!-- No data animation - centered in data preview -->
                <div class="no-data-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px;">
                  <dotlottie-wc src="https://lottie.host/807ebaf2-5ece-48b7-86f5-bae42faecb8b/nNDyZXmsdp.lottie"
                    style="width: 200px;height: 200px" autoplay loop></dotlottie-wc>
                  <p class="text-muted text-center mt-3">No data loaded. Import a CSV file to get started.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Operations Sidebar -->
          <div class="operations-sidebar">
            <div class="card-pro" style="height: 100%;">
              <div class="operations-tabs-container">
                <!-- Vertical Tabs -->
                <div class="vertical-tabs">
                  <button class="tab-button" onclick="switchTab('basic')">
                    <i class="bi bi-lightning-charge"></i> Basic
                  </button>
                  <button class="tab-button" onclick="switchTab('advance')">
                    <i class="bi bi-gear"></i> Advance
                  </button>
                  <button class="tab-button" onclick="switchTab('mapping')">
                    <i class="bi bi-diagram-3"></i> Mapping
                  </button>
                  <button class="tab-button" onclick="switchTab('transform')">
                    <i class="bi bi-braces"></i> Transform
                  </button>
                </div>

                <!-- Basic Tab Content -->
                <div id="basic-tab" class="tab-content">
                  <div class="mb-3">
                    <div class="tool-group-label">Quick actions</div>
                    <div class="tool-chip-row">
                      <button class="tool-chip success" onclick="callAction('standardize_text')">
                        <i class="bi bi-type"></i> Standardize text
                      </button>
                      <button class="tool-chip" onclick="callAction('remove_special_chars')">
                        <i class="bi bi-slash-circle"></i> Remove special chars
                      </button>
                      <button class="tool-chip" onclick="callAction('fix_dates')">
                        <i class="bi bi-calendar"></i> Fix dates
                      </button>
                      <button class="tool-chip" onclick="callAction('drop_missing')">
                        <i class="bi bi-dash-circle"></i> Drop missing rows
                      </button>
                      <button class="tool-chip" onclick="callAction('fill_missing')">
                        <i class="bi bi-plus-circle"></i> Fill missing with 0
                      </button>
                      <button class="tool-chip" onclick="showDataProfile()">
                        <i class="bi bi-bar-chart-line"></i> Data profile
                      </button>
                    </div>
                  </div>
                  <hr>

                  <div class="mb-2">
                    <div class="tool-group-label">
                    Duplicates
                    <div class="help-circle">
                      ?
                      <div class="help-tooltip">
                        Remove duplicate rows based on a selected column. Keeps the first occurrence and removes subsequent duplicates.
                      </div>
                    </div>
                  </div>
                    <div class="d-flex flex-wrap gap-2">
                      <select id="dupColumn" class="form-select mini-select" style="max-width:200px;">
                        <option value="">Select column for duplicates</option>
                      </select>
                      <button class="tool-chip danger" onclick="removeDuplicatesSelected()">
                        <i class="bi bi-layers-half"></i> Remove duplicates
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Advance Tab Content -->
                <div id="advance-tab" class="tab-content">
                  <div class="tool-group-label">
                    Alias Generator
                    <div class="help-circle">
                      ?
                      <div class="help-tooltip">
                        Generate sequential aliases with custom prefix and starting number. Useful for creating unique identifiers for records.
                      </div>
                    </div>
                  </div>
                  <div class="d-flex flex-wrap gap-2 mb-2">
                    <input type="text" id="aliasPrefix" class="form-control mini-input"
                      placeholder="Prefix (e.g. KSU-)">
                    <input type="text" id="aliasStart" class="form-control mini-input"
                      placeholder="Start number (e.g. 00001)">
                    <select id="aliasColumn" class="form-select mini-select" style="max-width:200px;">
                      <option value="">Select column</option>
                    </select>
                  </div>
                  <button class="tool-chip success" onclick="generateAlias()">
                    <i class="bi bi-list-ol"></i> Generate Aliases
                  </button>
                  <br>
                  <hr>
                  <div class="mb-3">
                    <div class="tool-group-label">
                    Select rows
                    <div class="help-circle">
                      ?
                      <div class="help-tooltip">
                        Filter rows based on specific values in a column. Choose to drop matching rows or keep only matching rows (drop others).
                      </div>
                    </div>
                  </div>
                    <div class="d-flex flex-wrap gap-2 mb-2">
                      <select id="dropTableColumn" class="form-select mini-select" style="max-width:200px;">
                        <option value="">Select column</option>
                      </select>
                      <input type="text" id="dropTableValue" class="form-control mini-input" placeholder="Value" />
                      <select id="dropAction" class="form-select mini-select" style="max-width:160px;">
                        <option value="drop">Drop selected</option>
                        <option value="keep">Keep selected (drop others)</option>
                      </select>
                    </div>
                    <button class="tool-chip danger" onclick="dropValue()">
                      <i class="bi bi-filter-circle"></i> Apply filter
                    </button>
                  </div>
                </div>

                <!-- Mapping Tab Content -->
                <div id="mapping-tab" class="tab-content">
                  <div class="row g-3">
                    <div class="col-12">
                      <div class="tool-group-label">
                      Subviolation Mapping
                      <div class="help-circle">
                        ?
                        <div class="help-tooltip">
                          Upload a mapping CSV with 'id' and 'name' columns, then apply to translate codes to descriptions in the selected target column.
                        </div>
                      </div>
                    </div>
                      <div class="d-flex flex-wrap gap-2 mb-2">
                        <input type="file" id="mappingInput" class="form-control form-control-sm" accept=".csv,.xlsx" />
                        <select id="mapTargetColumn" class="form-select mini-select" style="max-width:200px;">
                          <option value="">Select target column</option>
                        </select>
                      </div>
                      <div class="tool-chip-row">
                        <button class="tool-chip" onclick="uploadMappingCSV()">
                          <i class="bi bi-file-earmark-arrow-up"></i> Upload mapping CSV
                        </button>
                        <button class="tool-chip success" onclick="applySubviolationMapping()">
                          <i class="bi bi-diagram-3"></i> Apply mapping
                        </button>
                        <button class="tool-chip" onclick="toggleMappingSidebar()">
                          <i class="bi bi-layout-sidebar-inset"></i> Toggle mapping preview
                        </button>
                      </div>
                    </div>

                    <div class="col-12">
                      <hr>
                      <div class="tool-group-label">
                      Barangay Mapping
                      <div class="help-circle">
                        ?
                        <div class="help-tooltip">
                          Upload a barangay template and apply it to standardize address formats. Maps addresses to official barangay names with proper formatting.
                        </div>
                      </div>
                    </div>
                      <div class="d-flex flex-wrap gap-2 mb-2">
                        <input type="file" id="barangayInput" class="form-control form-control-sm" accept=".csv,.xlsx" />
                        <select id="barangayTarget" class="form-select mini-select" style="max-width:200px;">
                          <option value="">Select target column</option>
                        </select>
                      </div>
                      <div class="tool-chip-row">
                        <button class="tool-chip" onclick="uploadBarangayCSV()">
                          <i class="bi bi-file-earmark-arrow-up"></i> Upload barangay CSV
                        </button>
                        <button class="tool-chip success" onclick="applyBarangayMapping()">
                          <i class="bi bi-arrow-right-circle"></i> Apply mapping
                        </button>
                        <button class="tool-chip" onclick="toggleBarangaySidebar()">
                          <i class="bi bi-layout-sidebar-inset-reverse"></i> Toggle barangay preview
                        </button>
                        <button class="tool-chip danger" onclick="dropUnalignedBarangays()">
                          <i class="bi bi-trash"></i> Drop Unaligned
                        </button>
                        <button class="tool-chip" onclick="exportUnaligned()">
                          <i class="bi bi-download"></i> Export unaligned
                        </button>
                      </div>
                    </div>

                    <div class="col-12">
                      <hr>
                      <div class="tool-group-label">
                      DTI Business Mapping & Violation Detection
                      <div class="help-circle">
                        ?
                        <div class="help-tooltip">
                          Automatically map Line of Business to DTI categories and detect potential violations. Uses advanced pattern matching to categorize businesses and flag compliance issues.
                        </div>
                      </div>
                    </div>
                      <div class="d-flex flex-wrap gap-2 mb-2">
                        <select id="dtiTargetColumn" class="form-select mini-select" style="max-width:200px;">
                          <option value="">Select target column</option>
                        </select>
                      </div>
                      <div class="tool-chip-row">
                        <button class="tool-chip success" onclick="applyDTIMapping()">
                          <i class="bi bi-shield-exclamation"></i> Apply DTI Mapping & Violation Detection
                        </button>
                        <button class="tool-chip" onclick="applyCrimeMapping()">
                          <i class="bi bi-bank2"></i> Apply Crime Subviolation Mapping
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Transform Tab Content -->
                <div id="transform-tab" class="tab-content">
                  <div class="mb-3">
                    <div class="tool-group-label">Change data type</div>
                    <div class="d-flex flex-wrap gap-2">
                      <select id="dtypeColumn" class="form-select mini-select" style="max-width:200px;">
                        <option value="">Select column</option>
                      </select>
                      <select id="dtypeSelect" class="form-select mini-select" style="max-width:120px;">
                        <option value="int">int</option>
                        <option value="float">float</option>
                        <option value="str">str</option>
                        <option value="string">string</option>
                        <option value="bool">bool</option>
                        <option value="category">category</option>
                        <option value="datetime">datetime</option>
                        <option value="date">date</option>
                        <option value="time">time</option>
                        <option value="object">object</option>
                      </select>
                      <button class="tool-chip" onclick="changeDtype()">
                        <i class="bi bi-arrow-left-right"></i> Apply
                      </button>
                    </div>
                  </div>
                  <hr>

                  <div class="mb-3">
                    <div class="tool-group-label">Replace values</div>
                    <div class="d-flex flex-wrap gap-2 mb-2">
                      <select id="replaceColumn" class="form-select mini-select" style="max-width:200px;">
                        <option value="">Select column</option>
                      </select>
                      <input type="text" id="replaceFrom" class="form-control mini-input" placeholder="From" />
                      <input type="text" id="replaceTo" class="form-control mini-input" placeholder="To" />
                    </div>
                    <div class="tool-chip-row">
                      <button class="tool-chip" onclick="replaceValues(false)">
                        <i class="bi bi-arrow-repeat"></i> Replace (normal)
                      </button>
                      <button class="tool-chip danger" onclick="replaceValues(true)">
                        <i class="bi bi-shield-lock"></i> Replace (sensitive)
                      </button>
                    </div>
                  </div>
                  <hr>

                  <div class="mb-1">
                    <div class="tool-group-label">Columns</div>
                    <div class="d-flex flex-wrap gap-2 mb-2">
                      <select id="renameOld" class="form-select mini-select" style="max-width:200px;">
                        <option value="">Select column</option>
                      </select>
                      <input type="text" id="renameNew" class="form-control mini-input" placeholder="New name" />
                      <button class="tool-chip" onclick="renameColumn()">
                        <i class="bi bi-input-cursor-text"></i> Rename
                      </button>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                      <select id="dropColumn" class="form-select mini-select" style="max-width:200px;">
                        <option value="">Select column</option>
                      </select>
                      <button class="tool-chip danger" onclick="dropColumn()">
                        <i class="bi bi-x-octagon"></i> Drop column
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
      </main>
    </div>
  </div>

  <!-- TUTORIAL SIDEBAR -->
  <div id="tutorialSidebar" class="mapping-sidebar">
    <div class="sidebar-header">
      <span><strong>Function Tutorial</strong></span>
      <button onclick="toggleTutorialSidebar()">×</button>
    </div>
    <div class="p-3">
      <!-- Tutorial Navigation -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn-ghost" onclick="previousTutorial()" id="prevBtn">
          <i class="bi bi-arrow-left"></i> Previous
        </button>
        <span class="badge bg-primary" id="tutorialCounter">1 / 25</span>
        <button class="btn-ghost" onclick="nextTutorial()" id="nextBtn">
          Next <i class="bi bi-arrow-right"></i>
        </button>
      </div>

      <!-- Tutorial Content -->
      <div id="tutorialContent">
        <div class="tutorial-item">
          <h5 class="text-primary mb-3">
            <i class="bi bi-upload"></i> Load CSV Data
          </h5>
          <div class="mb-3">
            <strong>Route:</strong> <code>/load_csv</code> (POST)
          </div>
          <div class="mb-3">
            <strong>Description:</strong> Upload and load a CSV file into the application for data cleaning operations.
          </div>
          <div class="mb-3">
            <strong>Usage:</strong> Use the Import Data sidebar or drag & drop a CSV file. The system automatically
            detects file encoding.
          </div>
          <div class="mb-3">
            <strong>Features:</strong>
            <ul class="list-unstyled ms-3">
              <li>• Automatic encoding detection</li>
              <li>• CSV file validation</li>
              <li>• Clears history when loading new data</li>
            </ul>
          </div>
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Only CSV files are supported. The file must have proper headers.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAPPING SIDEBAR -->
  <div id="mappingSidebar" class="mapping-sidebar">
    <div class="sidebar-header">
      <span><strong>Mapping Preview</strong></span>
      <button onclick="toggleMappingSidebar()">×</button>
    </div>
    <div id="mappingPreview" class="p-3">
      <!-- Mapping preview will be loaded here -->
    </div>
  </div>

  <!-- BARANGAY SIDEBAR -->
  <div id="barangaySidebar" class="mapping-sidebar">
    <div class="sidebar-header">
      <span><strong>Barangay Mapping Preview</strong></span>
      <button onclick="toggleBarangaySidebar()">×</button>
    </div>
    <div id="barangayPreview" class="p-3">
      <!-- Barangay preview will be loaded here -->
    </div>
  </div>

  <!-- IMPORT MODAL -->
  <div id="importModal" class="modal">
    <div class="modal-content" style="width: 600px; max-width: 90%;">
      <span onclick="closeImportModal()" class="close-btn">&times;</span>
      <div class="modal-header">
        <h3><i class="bi bi-upload"></i> Import CSV Data</h3>
      </div>
      <div class="modal-body">
        <div class="dropzone" id="importDropzone">
          <div class="dropzone-icon">
            <i class="bi bi-cloud-arrow-up-fill"></i>
          </div>
          <div class="dropzone-title">Drop a CSV or Excel file here or click to browse</div>
          <div class="dropzone-subtext">CSV and Excel (.xlsx) formats are supported.</div>
          <input type="file" id="importFileInput" accept=".csv,.xlsx" />
          <div class="file-name" id="importFileNameDisplay"></div>
        </div>

        <div class="mt-4 d-flex justify-content-center gap-3">
          <button class="btn-soft" onclick="modalUploadCSV()">
            <i class="bi bi-upload"></i> Import CSV
          </button>
          <button class="magic-button" onclick="callAction('magic_clean')">
            <i class="bi bi-stars"></i> Magic Clean
            <span class="beta-label">Beta</span>
            <div class="sparkle-container"></div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart Modal -->
  <div id="chartModal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 800px;">
      <span onclick="closeChartModal()" class="close-btn">&times;</span>
      <h3>Chart Visualization</h3>
      <div class="mt-3">
        <canvas id="customChart" width="400" height="300"></canvas>
      </div>
    </div>
  </div>

  <!-- Data profile modal -->
  <div id="dataProfileModal">
    <div class="modal-content">
      <span onclick="closeModal()">&times;</span>
      <div id="modal-body">
        <!-- AJAX content goes here -->
      </div>
    </div>
  </div>

  <!-- About App Modal -->
  <div id="aboutModal" class="modal">
    <div class="modal-content" style="width: 700px; max-width: 90%;">
      <span onclick="closeAboutModal()" class="close-btn">&times;</span>
      <div class="modal-header">
        <h3><i class="bi bi-info-circle"></i> About Synqbox Data Cleaner</h3>
      </div>
      <div class="modal-body">
        <div class="mb-4">
          <h5 class="text-primary mb-3">Synqbox Data Cleaner v6.0.1</h5>
          <p class="text-muted">
            The Synqbox Data Cleaner has been designed to simplify the complex process of data cleaning, transformation, and analysis into an efficient, user-friendly experience. Throughout this guide, you have explored powerful features ranging from basic CSV import and text standardization to advanced tools such as automated Magic Clean, inline editing, data profiling, and intelligent mapping for structured data transformation. These tools work together to ensure that your datasets are accurate, consistent, and ready for real-world use Synqbox Cleaning Users Guide.
          </p>
        </div>
        
        <div class="mb-4">
          <h6 class="text-secondary mb-2">Data Quality & Decision Making</h6>
          <p class="text-muted">
            As data quality plays a critical role in decision-making, reporting, and system reliability, this application empowers users to confidently prepare and validate their data before further processing. With features such as undo history, real-time editing, and flexible exporting, the platform supports both beginners and advanced users in maintaining full control over their data workflow.
          </p>
        </div>
        
        <div class="mb-4">
          <h6 class="text-secondary mb-2">Continuous Evolution</h6>
          <p class="text-muted">
            This user guide serves as your reference in maximizing the full potential of the system. As development continues and new features are introduced, Synqbox Data Cleaner will continue to evolve to meet growing data preparation needs.
          </p>
        </div>
        
        <div class="alert alert-success mb-0">
          <i class="bi bi-heart-fill"></i> <strong>Thank you for using Synqbox Data Cleaner.</strong> We hope this tool becomes a valuable part of your data management and analytics process.
        </div>
      </div>
    </div>
  </div>

  <script>
    // Row selection and bulk delete functionality
    let selectedRows = new Set();
    let isSelecting = false;
    let selectionTimer = null;
    let selectionMode = false; // Flag to indicate selection mode is active

    function initializeRowSelection() {
      const table = document.querySelector('#output table.dataframe');
      if (!table) {
        console.log('No table found for row selection');
        return;
      }

      const rows = table.querySelectorAll('tbody tr');
      console.log(`Initializing row selection for ${rows.length} rows`);
      
      // Clear existing event listeners by cloning nodes
      rows.forEach(row => {
        const newRow = row.cloneNode(true);
        row.parentNode.replaceChild(newRow, row);
      });

      // Get fresh reference to rows after cloning
      const freshRows = table.querySelectorAll('tbody tr');
      
      freshRows.forEach((row, index) => {
        // Check if this row should be selected (based on data-id)
        const rowId = row.getAttribute('data-id');
        if (selectedRows.has(rowId)) {
          row.classList.add('selected');
          console.log(`Row ${rowId} is selected`);
        }

        // Prevent text selection while selecting
        row.addEventListener('selectstart', (e) => {
          if (isSelecting) e.preventDefault();
        });

        // Mouse down - start selection timer
        row.addEventListener('mousedown', (e) => {
          console.log(`Mouse down on row ${rowId}, page ${Math.floor(index / 20) + 1}`);
          if (e.button === 0) { // Left click only
            if (!selectionMode) {
              // First hold to activate selection mode
              isSelecting = true;
              row.classList.add('selecting');
              
              selectionTimer = setTimeout(() => {
                // Hold detected - activate selection mode and select this row
                console.log(`Selection mode activated on row ${rowId}`);
                selectionMode = true;
                toggleRowSelection(row);
                row.classList.remove('selecting');
              }, 500); // 500ms hold time
            } else {
              // Selection mode is active - simple click to toggle
              toggleRowSelection(row);
            }
          }
        });

        // Mouse up - cancel selection timer if not held
        row.addEventListener('mouseup', () => {
          if (selectionTimer && !selectionMode) {
            clearTimeout(selectionTimer);
            selectionTimer = null;
          }
          row.classList.remove('selecting');
          isSelecting = false;
        });

        // Mouse leave - cancel selection timer
        row.addEventListener('mouseleave', () => {
          if (selectionTimer && !selectionMode) {
            clearTimeout(selectionTimer);
            selectionTimer = null;
          }
          row.classList.remove('selecting');
        });
      });

      // Global mouse up to reset selection state
      document.addEventListener('mouseup', () => {
        if (selectionTimer && !selectionMode) {
          clearTimeout(selectionTimer);
          selectionTimer = null;
        }
        document.querySelectorAll('.selecting').forEach(row => {
          row.classList.remove('selecting');
        });
        isSelecting = false;
      });
    }

    function unselectAllRows() {
      selectedRows.clear();
      selectionMode = false;
      
      // Remove selected class from all rows
      document.querySelectorAll('.dataframe tbody tr.selected').forEach(row => {
        row.classList.remove('selected');
      });
      
      updateSelectionUI();
    }

    function toggleRowSelection(row) {
      const rowId = row.getAttribute('data-id');
      if (!rowId) return;

      if (selectedRows.has(rowId)) {
        selectedRows.delete(rowId);
        row.classList.remove('selected');
      } else {
        selectedRows.add(rowId);
        row.classList.add('selected');
      }

      updateSelectionUI();
    }

    function updateSelectionUI() {
      const count = selectedRows.size;
      const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      const undoBtn = document.getElementById('undoBtn');
      const selectedCount = document.getElementById('selectedCount');

      // Check if there's data loaded
      const hasData = document.querySelector('#output table.dataframe') !== null;

      // Show refresh and undo buttons only when data is loaded
      refreshBtn.style.display = hasData ? 'inline-flex' : 'none';
      undoBtn.style.display = hasData ? 'inline-flex' : 'none';

      if (count > 0) {
        bulkDeleteBtn.style.display = 'inline-flex';
        cancelBtn.style.display = 'inline-flex';
        selectedCount.textContent = count;
      } else {
        bulkDeleteBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        selectedCount.textContent = '0';
        // Also exit selection mode when no rows are selected
        selectionMode = false;
      }
    }

    async function bulkDeleteRows() {
      if (selectedRows.size === 0) {
        alert('No rows selected for deletion.');
        return;
      }

      if (!confirm(`Are you sure you want to delete ${selectedRows.size} selected row(s)? This action cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch('/bulk_delete_rows', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            row_ids: Array.from(selectedRows)
          })
        });

        if (response.ok) {
          const html = await response.text();
          document.getElementById('output').innerHTML = html;
          initDataTable();
          
          // Clear visual selection first, then clear state
          setTimeout(() => {
            // Remove any remaining visual selection
            document.querySelectorAll('.dataframe tbody tr.selected').forEach(row => {
              row.classList.remove('selected');
            });
            
            // Clear selection state after successful deletion
            selectedRows.clear();
            selectionMode = false;
            updateSelectionUI();
          }, 200);
        } else {
          alert('Error deleting rows. Please try again.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error deleting rows. Please try again.');
      }
    }

    // Helper: Update target column dropdowns with current data headers
    function updateTargetColumnDropdowns() {
      // Get column headers from the current data table
      const table = document.querySelector('#output table');
      if (!table) return;

      const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());

      // Update barangay target dropdown
      const barangayTarget = document.getElementById('barangayTarget');
      if (barangayTarget) {
        barangayTarget.innerHTML = '<option value="">Select target column</option>';
        headers.forEach(header => {
          const option = document.createElement('option');
          option.value = header;
          option.textContent = header;
          barangayTarget.appendChild(option);
        });
      }

      // Update duplicates column dropdown
      const dupColumn = document.getElementById('dupColumn');
      if (dupColumn) {
        dupColumn.innerHTML = '<option value="">Select column</option>';
        headers.forEach(header => {
          const option = document.createElement('option');
          option.value = header;
          option.textContent = header;
          dupColumn.appendChild(option);
        });
      }

      // Update filter column dropdown
      const dropTableColumn = document.getElementById('dropTableColumn');
      if (dropTableColumn) {
        dropTableColumn.innerHTML = '<option value="">Select column</option>';
        headers.forEach(header => {
          const option = document.createElement('option');
          option.value = header;
          option.textContent = header;
          dropTableColumn.appendChild(option);
        });
      }

      // Update alias column dropdown
      const aliasColumn = document.getElementById('aliasColumn');
      if (aliasColumn) {
        aliasColumn.innerHTML = '<option value="">Select column</option>';
        headers.forEach(header => {
          const option = document.createElement('option');
          option.value = header;
          option.textContent = header;
          aliasColumn.appendChild(option);
        });
      }

      // Update subviolation mapping target column dropdown
      const mapTargetColumn = document.getElementById('mapTargetColumn');
      if (mapTargetColumn) {
        mapTargetColumn.innerHTML = '<option value="">Select target column</option>';
        headers.forEach(header => {
          const option = document.createElement('option');
          option.value = header;
          option.textContent = header;
          mapTargetColumn.appendChild(option);
        });
      }

      // Update DTI mapping target column dropdown
      const dtiTargetColumn = document.getElementById('dtiTargetColumn');
      if (dtiTargetColumn) {
        dtiTargetColumn.innerHTML = '<option value="">Select target column</option>';
        headers.forEach(header => {
          const option = document.createElement('option');
          option.value = header;
          option.textContent = header;
          dtiTargetColumn.appendChild(option);
        });
      }

      // Update Transform tab dropdowns
      const dtypeColumn = document.getElementById('dtypeColumn');
      if (dtypeColumn) {
        dtypeColumn.innerHTML = '<option value="">Select column</option>';
        headers.forEach(header => {
          const option = document.createElement('option');
          option.value = header;
          option.textContent = header;
          dtypeColumn.appendChild(option);
        });
      }

      const replaceColumn = document.getElementById('replaceColumn');
      if (replaceColumn) {
        replaceColumn.innerHTML = '<option value="">Select column</option>';
        headers.forEach(header => {
          const option = document.createElement('option');
          option.value = header;
          option.textContent = header;
          replaceColumn.appendChild(option);
        });
      }

      const renameOld = document.getElementById('renameOld');
      if (renameOld) {
        renameOld.innerHTML = '<option value="">Select column</option>';
        headers.forEach(header => {
          const option = document.createElement('option');
          option.value = header;
          option.textContent = header;
          renameOld.appendChild(option);
        });
      }

      const dropColumnTransform = document.getElementById('dropColumn');
      if (dropColumnTransform) {
        dropColumnTransform.innerHTML = '<option value="">Select column</option>';
        headers.forEach(header => {
          const option = document.createElement('option');
          option.value = header;
          option.textContent = header;
          dropColumnTransform.appendChild(option);
        });
      }
    }

    // Helper: Initialize DataTable on any new table
    function initDataTable() {
      $("#mappingPreview table, #output table, #barangayPreview table, #unalignedTable table").each(function () {
        if ($.fn.DataTable.isDataTable(this)) {
          $(this).DataTable().destroy();
        }

        const dataTable = $(this).DataTable({
          pageLength: 20,
          lengthMenu: [10, 20, 50, 100],
          responsive: true,
          orderCellsTop: true,
          fixedHeader: true,
          drawCallback: function() {
            // Reinitialize row selection after each draw (pagination, sorting, etc.)
            const tableContainer = this.api().table().container();
            if ($(tableContainer).closest('#output').length > 0) {
              setTimeout(() => {
                initializeRowSelection();
              }, 100);
            }
          }
        });
      });

      // Update target column dropdowns after initializing tables
      updateTargetColumnDropdowns();

      // Initialize row selection for data table
      initializeRowSelection();

      // Update UI to show refresh button when data is loaded
      updateSelectionUI();

      // Make output table editable after DataTable initialization
      setTimeout(() => {
        if ($("#output table").length && $("#output table").hasClass('dataTable')) {
          makeTableEditable();
        } else {
          console.log("Table not ready for editing, retrying...");
          setTimeout(() => {
            if ($("#output table").length) {
              makeTableEditable();
            }
          }, 500);
        }
      }, 200);
    }


    let activeTab = null;

    function switchTab(tabName) {
      const tabContent = document.getElementById(`${tabName}-tab`);
      const tabButton = document.querySelector(`.tab-button[onclick*="${tabName}"]`);
      const mainCard = document.querySelector('.card-pro');

      // If clicking the same tab, toggle it off
      if (activeTab === tabName) {
        if (tabContent) tabContent.classList.remove('active');
        if (tabButton) tabButton.classList.remove('active');
        if (mainCard) mainCard.classList.remove('tab-open');
        activeTab = null;
        return;
      }

      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });

      // Remove active class from all tab buttons
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
      });

      // Show the selected tab content
      if (tabContent) {
        tabContent.classList.add('active');
      }

      // Add active class to the clicked tab button
      if (tabButton) {
        tabButton.classList.add('active');
      }

      // Adjust main card width
      if (mainCard) {
        mainCard.classList.add('tab-open');
      }

      activeTab = tabName;

      // Scroll the content to top
      if (tabContent) {
        tabContent.scrollTop = 0;
      }
    }

    function showLoader() {
      const loader = document.getElementById('loader');
      if (loader) loader.style.display = 'block';
    }

    function hideLoader() {
      const loader = document.getElementById('loader');
      if (loader) loader.style.display = 'none';
    }

    // Generalized fetch wrapper with loader
    async function fetchWithLoader(url, options = {}) {
      showLoader();
      try {
        const response = await fetch(url, options);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const text = await response.text();
        return text;
      } catch (err) {
        alert("Error: " + err);
        console.error(err);
        return null;
      } finally {
        hideLoader();
      }
    }

    async function generateAlias() {
      const prefix = document.getElementById('aliasPrefix').value.trim();
      const start = document.getElementById('aliasStart').value.trim();
      const column = document.getElementById('aliasColumn').value.trim();

      if (!prefix || !start || !column) {
        alert("Please fill in all alias fields.");
        return;
      }

      const formData = new FormData();
      formData.append("prefix", prefix);
      formData.append("start", start);
      formData.append("column", column);

      const data = await fetchWithLoader('/generate_alias', {
        method: "POST",
        body: formData
      });

      if (data) {
        document.getElementById("output").innerHTML = data;
        initDataTable();
      }
    }


    // --- CSV upload (main Load Data card) ---
    async function uploadCSV() {
      const fileInput = document.getElementById('fileInput');
      if (!fileInput.files.length) {
        alert("Please select a CSV file to upload.");
        return;
      }
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      const data = await fetchWithLoader('/load_csv', { method: 'POST', body: formData });
      if (data) {
        document.getElementById('output').innerHTML = data;
        initDataTable();
      }
    }

    async function loadSample() {
      const data = await fetchWithLoader('/load_sample');
      if (data) {
        document.getElementById('output').innerHTML = data;
        initDataTable();
      }
    }

    async function removeDuplicatesSelected() {
      const col = document.getElementById('dupColumn').value.trim();
      if (!col) return alert('Please enter a column name.');
      const data = await fetchWithLoader(`/remove_duplicates_by_column?column=${encodeURIComponent(col)}`);
      if (data) {
        document.getElementById('output').innerHTML = data;
        initDataTable();
      }
    }

    async function changeDtype() {
      const column = document.getElementById('dtypeColumn').value.trim();
      const dtype = document.getElementById('dtypeSelect').value;
      if (!column) return alert('Please enter a column name.');
      const data = await fetchWithLoader(`/change_dtype?column=${encodeURIComponent(column)}&dtype=${encodeURIComponent(dtype)}`);
      if (data) {
        document.getElementById('output').innerHTML = data;
        initDataTable();
      }
    }

    async function replaceValues(sensitive = false, page = 1) {
      const column = document.getElementById('replaceColumn').value.trim();
      const from = document.getElementById('replaceFrom').value;
      const to = document.getElementById('replaceTo').value;
      if (!column) return alert('Please enter a column name.');

      const endpoint = sensitive ? "/replace_values_sensitive" : "/replace_values";
      const data = await fetchWithLoader(`${endpoint}?column=${encodeURIComponent(column)}&replace_from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&page=${page}`);
      if (data) {
        document.getElementById('output').innerHTML = data;
        initDataTable();
      }
    }

    async function renameColumn() {
      const oldName = document.getElementById('renameOld').value.trim();
      const newName = document.getElementById('renameNew').value.trim();
      if (!oldName || !newName) return alert('Please enter both old and new column names.');

      const data = await fetchWithLoader(`/rename_column?old=${encodeURIComponent(oldName)}&new=${encodeURIComponent(newName)}`);
      if (data) {
        document.getElementById('output').innerHTML = data;
        initDataTable();
      }
    }

    async function dropColumn() {
      const column = document.getElementById('dropColumn').value.trim();
      if (!column) return alert('Please enter a column name.');

      const data = await fetchWithLoader(`/drop_column?column=${encodeURIComponent(column)}`);
      if (data) {
        document.getElementById('output').innerHTML = data;
        initDataTable();
      }
    }

    async function undoReplace() {
      const data = await fetchWithLoader('/undo_replace');
      if (data) {
        document.getElementById('output').innerHTML = data;
        initDataTable();
      }
    }

    async function showDataProfile() {
      const html = await fetchWithLoader('/data_profile');
      if (html) {
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('dataProfileModal').style.display = 'block';
      }
    }

    function isCSV(file) {
      return file && (file.name.toLowerCase().endsWith(".csv") || file.name.toLowerCase().endsWith(".xlsx"));
    }

    function closeModal() {
      document.getElementById('dataProfileModal').style.display = 'none';
    }

    function showAboutModal() {
      document.getElementById('aboutModal').style.display = 'block';
    }

    function closeAboutModal() {
      document.getElementById('aboutModal').style.display = 'none';
    }

    async function dropValue() {
      const column = document.getElementById('dropTableColumn').value;
      const value = document.getElementById('dropTableValue').value;
      const action = document.getElementById('dropAction').value;
      if (!column || !value) return alert("Please enter both column name and value.");

      const data = await fetchWithLoader(`/drop_value?column=${encodeURIComponent(column)}&value=${encodeURIComponent(value)}&action=${action}`);
      if (data) {
        document.getElementById('output').innerHTML = data;
        initDataTable();
      }
    }

    // --- Drag & drop for main Load Data card ---
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const fileNameDisplay = document.getElementById('fileNameDisplay');

    if (dropzone && fileInput && fileNameDisplay) {
      dropzone.addEventListener('click', (e) => {
        if (e.target.closest('button')) return;
        fileInput.click();
      });

      dropzone.addEventListener('dragover', e => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });

      dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));

      dropzone.addEventListener('drop', e => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          showFileName(files[0].name);
          fileInput.dispatchEvent(new Event('change'));
        }
      });

      fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) showFileName(fileInput.files[0].name);
      });
    }

    function showFileName(name) { fileNameDisplay.textContent = `Selected file: ${name}`; }

    // General action caller
    async function callAction(endpoint) {
      const html = await fetchWithLoader(`/${endpoint}`);
      if (html) {
        document.getElementById('output').innerHTML = html;
        initDataTable();
        alert('✔️ Action "' + endpoint + '" complete!');
      }
    }

    // --- ChartJS ---
    let chartInstance = null;
    async function drawChart() {
      const chartType = document.getElementById("chartType").value;
      const xColumn = document.getElementById("xAxisColumn").value;
      const yColumn = document.getElementById("yAxisColumn").value;

      if (!xColumn || !yColumn) {
        alert("Please enter both X and Y axis column names.");
        return;
      }

      try {
        showLoader();
        const res = await fetch(`/generate_chart_data?x=${encodeURIComponent(xColumn)}&y=${encodeURIComponent(yColumn)}`);

        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        const contentType = res.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
          const text = await res.text();
          throw new Error("Server returned non-JSON response. Check column names and data.");
        }

        const data = await res.json();

        // Show modal and create chart
        document.getElementById("chartModal").style.display = "block";

        const ctx = document.getElementById("customChart").getContext("2d");
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
          type: chartType,
          data: {
            labels: data.labels,
            datasets: [{
              label: `${yColumn} vs ${xColumn}`,
              data: data.values,
              borderWidth: 2,
              fill: chartType === 'line' ? false : true,
              backgroundColor: chartType === 'pie' || chartType === 'doughnut' ?
                ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'] :
                'rgba(54, 162, 235, 0.2)',
              borderColor: chartType === 'pie' || chartType === 'doughnut' ?
                ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'] :
                'rgba(54, 162, 235, 1)'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: chartType === 'pie' || chartType === 'doughnut'
              }
            },
            scales: chartType === 'bar' || chartType === 'line' ? {
              y: {
                beginAtZero: true
              }
            } : {}
          }
        });
      } catch (err) {
        alert("Chart load failed: " + err.message);
        console.error("Chart error:", err);
      } finally {
        hideLoader();
      }
    }

    function closeChartModal() {
      document.getElementById("chartModal").style.display = "none";
      if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
      }
    }

    // --- Editable Table Functionality ---
    let editableTable = null;

    function makeTableEditable() {
      // ✅ Kill previous bindings to prevent stacking
      $(document).off('dblclick.editCell');

      // ✅ Works with DataTables, responsive rows, pagination, sorting
      $(document).on('dblclick.editCell', '#output table td', function () {
        const cell = $(this);

        const tableEl = $('#output table');
        const dataTable = tableEl.DataTable();

        // If already editing, block re-entry
        if (cell.find('input').length) return;

        const originalValue = cell.text().trim();

        // ✅ Get real column index safely
        const cellIndex = dataTable.cell(cell).index();
        if (!cellIndex) return;

        const colIndex = cellIndex.column;
        const columnName = tableEl.find('thead th').eq(colIndex).text().trim();

        if (!columnName || columnName.toLowerCase() === 'index') return;

        // ✅ Get real row id from HTML (your Flask data-id)
        const rowId = cell.closest('tr').attr('data-id');
        if (!rowId) {
          console.error("❌ Missing data-id on row");
          return;
        }

        // ✅ Inject input
        const input = $('<input type="text">').val(originalValue).css({
          width: '100%',
          border: 'none',
          padding: '4px',
          fontSize: 'inherit'
        });

        cell.html(input);
        input.focus().select();

        function saveEdit() {
          const newValue = input.val().trim();
          cell.text(newValue);

          if (newValue !== originalValue) {
            updateCell(rowId, colIndex, columnName, newValue, originalValue);
          }
        }

        input.on('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit();
          } else if (e.key === 'Escape') {
            cell.text(originalValue);
          }
        });

        input.on('blur', saveEdit);
      });

      // ✅ Visual UX indicators
      $('#output table').find('td').css({
        cursor: 'pointer',
        position: 'relative'
      });
    }


    async function updateCell(rowId, colIndex, columnName, newValue, originalValue) {
      try {
        showLoader();

        const formData = new FormData();
        formData.append('row_id', rowId);          // ✅ REAL DB ID
        formData.append('column_name', columnName);
        formData.append('new_value', newValue);
        formData.append('original_value', originalValue);

        const response = await fetch('/update_cell', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        await response.text();
        console.log('✅ Correct row updated in database');

        // ✅ Highlight the exact edited cell safely
        const table = $('#output table').DataTable();
        const cellNode = table
          .cell({ row: $(`tr[data-id="${rowId}"]`), column: colIndex })
          .node();

        $(cellNode).css('background-color', '#d4edda');
        setTimeout(() => $(cellNode).css('background-color', ''), 1000);

      } catch (error) {
        console.error('❌ Error updating cell:', error);
        alert('Update failed. Reverting value.');

        const table = $('#output table').DataTable();
        const cellNode = table
          .cell({ row: $(`tr[data-id="${rowId}"]`), column: colIndex })
          .node();

        $(cellNode).text(originalValue);

      } finally {
        hideLoader();
      }
    }


    const sparkleContainer = document.querySelector('.sparkle-container');
    const sparkleChars = ['✨'];
    function createSparkle() {
      if (!sparkleContainer) return;
      const sparkle = document.createElement('span');
      sparkle.classList.add('sparkle');
      sparkle.innerText = sparkleChars[Math.floor(Math.random() * sparkleChars.length)];
      sparkle.style.left = `${Math.random() * 100}%`;
      sparkle.style.top = `${Math.random() * 100}%`;
      sparkle.style.fontSize = `${12 + Math.random() * 10}px`;
      sparkleContainer.appendChild(sparkle);
      setTimeout(() => sparkle.remove(), 4000);
    }
    setInterval(createSparkle, 500);

    function toggleMappingSidebar() {
      const sidebar = document.getElementById("mappingSidebar");
      document.body.classList.toggle("sidebar-open");
      sidebar.classList.toggle("open");
    }

    function toggleBarangaySidebar() {
      const sidebar = document.getElementById("barangaySidebar");
      document.body.classList.toggle("sidebar-open");
      sidebar.classList.toggle("open");
    }

    // --- Mapping uploads ---
    async function uploadMappingCSV(page = 1) {
      const fileInput = document.getElementById("mappingInput");
      const file = fileInput.files[0];
      if (!file) return alert("Please select a mapping CSV file.");
      if (!isCSV(file)) return alert("❌ Only CSV files are allowed for mapping.");
      const formData = new FormData();
      formData.append("file", file);

      const html = await fetchWithLoader(`/upload_mapping_csv`, { method: "POST", body: formData });
      if (html) {
        document.getElementById("mappingPreview").innerHTML = html;
        document.getElementById("mappingSidebar").classList.add("open");
        document.body.classList.add("sidebar-open");
        initDataTable();
      }
    }

    async function applySubviolationMapping() {
      const targetCol = document.getElementById("mapTargetColumn").value;
      if (!targetCol) return alert("Please specify the target column to map (e.g. subviolation)");
      const html = await fetchWithLoader(`/apply_subviolation_mapping?target_col=${encodeURIComponent(targetCol)}`);
      if (html) {
        document.getElementById("output").innerHTML = html;
        initDataTable();
      }
    }

    async function applyDTIMapping() {
      const targetCol = document.getElementById("dtiTargetColumn").value;
      if (!targetCol) return alert("Please select a target column for DTI mapping.");
      const html = await fetchWithLoader(`/apply_dti_mapping?target_col=${encodeURIComponent(targetCol)}`);
      if (html) {
        document.getElementById("output").innerHTML = html;
        initDataTable();
        updateSelectionUI();
      }
    }

    async function applyCrimeMapping() {
      const targetCol = document.getElementById("dtiTargetColumn").value;
      if (!targetCol) return alert("Please select a target column for crime subviolation mapping.");
      const html = await fetchWithLoader(`/apply_crime_mapping?target_col=${encodeURIComponent(targetCol)}`);
      if (html) {
        document.getElementById("output").innerHTML = html;
        initDataTable();
        updateSelectionUI();
      }
    }

    function editRow(button) {
      const row = button.closest('tr');
      const rowId = button.getAttribute('data-row-id');
      const cells = row.querySelectorAll('td');
      
      // Skip the first cell (edit button) and header row
      const table = document.querySelector('#output table');
      const headers = Array.from(table.querySelectorAll('thead th')).slice(1).map(th => th.textContent.trim());
      
      // Create edit modal with improved UI
      const modal = document.createElement('div');
      modal.className = 'edit-modal';
      modal.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        padding: 0;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 700px;
        max-height: 85vh;
        overflow: hidden;
        border: 1px solid #e2e8f0;
        animation: modalSlideIn 0.3s ease-out;
      `;
      
      // Add animation keyframes
      if (!document.querySelector('#modal-animations')) {
        const style = document.createElement('style');
        style.id = 'modal-animations';
        style.textContent = `
          @keyframes modalSlideIn {
            from {
              opacity: 0;
              transform: translate(-50%, -45%) scale(0.95);
            }
            to {
              opacity: 1;
              transform: translate(-50%, -50%) scale(1);
            }
          }
          .edit-modal-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 20px 24px;
            border-radius: 16px 16px 0 0;
            position: relative;
          }
          .edit-modal-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
          }
          .edit-modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 0 0 16px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          }
          .edit-form-group {
            margin-bottom: 20px;
            transition: all 0.2s ease;
          }
          .edit-form-group:hover {
            transform: translateX(4px);
          }
          .edit-form-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }
          .edit-form-input {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
          }
          .edit-form-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
          }
          .edit-btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none;
            color: white;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
          }
          .edit-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
          }
          .edit-btn-secondary {
            background: white;
            border: 2px solid #e5e7eb;
            color: #6b7280;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
          }
          .edit-btn-secondary:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
          }
          .edit-changes-indicator {
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
          }
        `;
        document.head.appendChild(style);
      }
      
      let formHtml = `
        <div class="edit-modal-header">
          <h5 class="mb-0 d-flex align-items-center">
            <i class="bi bi-pencil-square me-2"></i>
            Edit Row #${rowId}
          </h5>
          <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" onclick="closeEditModal(this)"></button>
        </div>
        <div class="edit-modal-body">
          <div class="row g-3">
      `;
      
      headers.forEach((header, index) => {
        const cellIndex = index + 1; // Skip edit button column
        const currentValue = cells[cellIndex] ? cells[cellIndex].textContent.trim() : '';
        formHtml += `
          <div class="col-md-6">
            <div class="edit-form-group">
              <label class="edit-form-label">${header}</label>
              <input type="text" class="edit-form-input w-100" id="col_${index}" value="${currentValue}" data-column="${header}" data-original="${currentValue}">
            </div>
          </div>
        `;
      });
      
      formHtml += `
          </div>
        </div>
        <div class="edit-modal-footer">
          <div class="edit-changes-indicator">
            <i class="bi bi-info-circle me-1"></i>
            Modified fields will be highlighted
          </div>
          <div class="d-flex gap-2">
            <button type="button" class="edit-btn-secondary" onclick="closeEditModal(this)">
              <i class="bi bi-x-lg me-1"></i> Cancel
            </button>
            <button type="button" class="edit-btn-primary" onclick="saveRowEdit(${rowId}, this)">
              <i class="bi bi-check-lg me-1"></i> Save Changes
            </button>
          </div>
        </div>
      `;
      
      modal.innerHTML = formHtml;
      document.body.appendChild(modal);
      
      // Add change tracking
      const inputs = modal.querySelectorAll('.edit-form-input');
      inputs.forEach(input => {
        input.addEventListener('input', function() {
          if (this.value !== this.getAttribute('data-original')) {
            this.style.borderColor = '#10b981';
            this.style.backgroundColor = '#f0fdf4';
          } else {
            this.style.borderColor = '#e5e7eb';
            this.style.backgroundColor = 'white';
          }
        });
      });
      
      // Add backdrop with blur effect
      const backdrop = document.createElement('div');
      backdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.4);
        backdrop-filter: blur(4px);
        z-index: 9999;
        animation: fadeIn 0.2s ease-out;
      `;
      
      // Add fade animation
      if (!document.querySelector('#backdrop-animations')) {
        const backdropStyle = document.createElement('style');
        backdropStyle.id = 'backdrop-animations';
        backdropStyle.textContent = `
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
          }
          @keyframes modalSlideOut {
            from {
              opacity: 1;
              transform: translate(-50%, -50%) scale(1);
            }
            to {
              opacity: 0;
              transform: translate(-50%, -55%) scale(0.95);
            }
          }
          @keyframes slideInRight {
            from {
              opacity: 0;
              transform: translateX(100%);
            }
            to {
              opacity: 1;
              transform: translateX(0);
            }
          }
          @keyframes slideOutRight {
            from {
              opacity: 1;
              transform: translateX(0);
            }
            to {
              opacity: 0;
              transform: translateX(100%);
            }
          }
        `;
        document.head.appendChild(backdropStyle);
      }
      
      backdrop.onclick = () => {
        closeEditModal(modal.querySelector('.btn-close'));
      };
      document.body.appendChild(backdrop);
      
      // Focus first input
      setTimeout(() => {
        const firstInput = modal.querySelector('.edit-form-input');
        if (firstInput) {
          firstInput.focus();
          firstInput.select();
        }
      }, 100);
    }

    function saveRowEdit(rowId, button) {
      const modal = button.closest('.edit-modal');
      const inputs = modal.querySelectorAll('.edit-form-input');
      
      const updates = [];
      inputs.forEach(input => {
        const columnName = input.getAttribute('data-column');
        const newValue = input.value.trim();
        const originalValue = input.getAttribute('data-original');
        
        if (newValue !== originalValue) {
          updates.push({ columnName, newValue, originalValue });
        }
      });
      
      if (updates.length === 0) {
        closeEditModal(button);
        return;
      }
      
      // Show loading state
      const saveBtn = button;
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Saving...';
      saveBtn.disabled = true;
      
      // Process updates one by one
      Promise.all(updates.map(update => {
        const formData = new FormData();
        formData.append('row_id', rowId);
        formData.append('column_name', update.columnName);
        formData.append('new_value', update.newValue);
        formData.append('original_value', update.originalValue);
        
        return fetch('/update_cell', {
          method: 'POST',
          body: formData
        });
      })).then(() => {
        closeEditModal(button);
        // Show success message
        showNotification('Changes saved successfully!', 'success');
        // Update table directly without reload
        updates.forEach(update => {
          const table = document.querySelector('#output table');
          const headers = Array.from(table.querySelectorAll('thead th')).slice(1).map(th => th.textContent.trim());
          const colIndex = headers.indexOf(update.columnName);
          if (colIndex !== -1) {
            const row = table.querySelector(`tr[data-id="${rowId}"]`);
            if (row) {
              const cell = row.querySelectorAll('td')[colIndex + 1]; // +1 for edit button column
              if (cell) {
                cell.textContent = update.newValue;
              }
            }
          }
        });
      }).catch(error => {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
        showNotification('Error saving changes: ' + error.message, 'error');
      });
    }

    function closeEditModal(button) {
      const modal = button.closest('.edit-modal') || document.querySelector('.edit-modal');
      const backdrop = document.querySelector('div[style*="backdrop-filter: blur"]');
      if (modal) {
        modal.style.animation = 'modalSlideOut 0.2s ease-in';
        setTimeout(() => {
          if (modal.parentNode) document.body.removeChild(modal);
        }, 200);
      }
      if (backdrop) {
        backdrop.style.animation = 'fadeOut 0.2s ease-in';
        setTimeout(() => {
          if (backdrop.parentNode) document.body.removeChild(backdrop);
        }, 200);
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
      notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 10001;
        min-width: 300px;
        animation: slideInRight 0.3s ease-out;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      `;
      
      notification.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="bi bi-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
          ${message}
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    async function uploadBarangayCSV() {
      const file = document.getElementById("barangayInput").files[0];
      const targetColumn = document.getElementById("barangayTarget").value.trim();
      if (!file) return alert("Please select a Barangay CSV file.");
      if (!isCSV(file)) return alert("❌ Only CSV files are allowed.");
      if (!targetColumn) return alert("Please enter a target column name.");

      const formData = new FormData();
      formData.append("file", file);
      formData.append("targetColumn", targetColumn);

      const html = await fetchWithLoader("/upload_barangay_csv", { method: "POST", body: formData });
      if (html) {
        document.getElementById("barangayPreview").innerHTML = html;
        document.getElementById("barangaySidebar").classList.add("open");
        document.body.classList.add("sidebar-open");
        initDataTable();
      }
    }

    async function applyBarangayMapping() {
      const targetColumn = document.getElementById("barangayTarget").value.trim();
      if (!targetColumn) return alert("Please enter a target column name.");

      const formData = new FormData();
      formData.append("targetColumn", targetColumn);

      const html = await fetchWithLoader("/apply_barangay_mapping", { method: "POST", body: formData });
      if (html) {
        document.getElementById("output").innerHTML = html;
        initDataTable();
      }
    }

    async function dropUnalignedBarangays() {
      const targetColumn = document.getElementById("barangayTarget").value.trim();
      if (!targetColumn) {
        alert("Please enter a target column name first.");
        return;
      }

      if (!confirm("Are you sure you want to drop all unaligned barangays? This will remove rows that don't match the barangay template and export them to a CSV file.")) {
        return;
      }

      // This will both export unaligned and drop them from the main dataset
      const response = await fetch(`/export_unaligned_barangays?targetColumn=${encodeURIComponent(targetColumn)}`);
      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'unaligned_barangays.csv';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        // Refresh the main data preview
        const html = await fetchWithLoader('/reload_data');
        if (html) {
          document.getElementById("output").innerHTML = html;
          initDataTable();
        }

        alert("Unaligned barangays have been dropped and exported successfully!");
      } else {
        alert("Error processing unaligned barangays.");
      }
    }

    async function showUnalignedBarangays() {
      const html = await fetchWithLoader('/show_unaligned_barangays');
      if (html) {
        document.getElementById('unalignedTable').innerHTML = html;
        document.getElementById('unalignedModal').style.display = 'block';
        initDataTable();
      }
    }

    function closeUnalignedModal() {
      document.getElementById('unalignedModal').style.display = 'none';
    }

    function exportUnaligned() {
      const targetColumn = document.getElementById("barangayTarget").value.trim();
      if (!targetColumn) return alert("Please enter a target column name.");
      window.location.href = `/export_unaligned_barangays?targetColumn=${encodeURIComponent(targetColumn)}`;
    }

    async function reloadData(page = 1) {
      showLoader();
      try {
        // Add timestamp to prevent caching
        const timestamp = new Date().getTime();
        const res = await fetch(`/reload_data?page=${page}&t=${timestamp}`, {
          headers: {
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          }
        });
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const html = await res.text();

        document.getElementById('output').innerHTML = html;
        initDataTable();
      } catch (err) {
        console.error(err);
        alert("Failed to reload data: " + err);
      } finally {
        hideLoader();
      }
    }

    // Export CSV function - downloads without navigation
    function exportCSV() {
      const link = document.createElement('a');
      link.href = '/export_csv';
      link.download = ''; // Let browser determine filename from server
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Export Excel function - downloads without navigation
    function exportExcel() {
      const link = document.createElement('a');
      link.href = '/export_excel';
      link.download = ''; // Let browser determine filename from server
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Ask for confirmation before leaving the page (only when actually leaving)
    window.addEventListener("beforeunload", function (e) {
      const confirmationMessage = "You have unsaved changes. Make sure to export your cleaned CSV before leaving.";
      e.preventDefault();
      e.returnValue = confirmationMessage;
      return confirmationMessage;
    });

    function toggleImportModal() {
      document.getElementById('importModal').style.display = 'block';
    }

    function closeImportModal() {
      document.getElementById('importModal').style.display = 'none';
    }

    function toggleImportSidebar() {
      const sidebar = document.getElementById("importSidebar");
      document.body.classList.toggle("sidebar-open");
      sidebar.classList.toggle("open");
    }

    async function sidebarUploadCSV() {
      const fileInput = document.getElementById('importFileInput');
      if (!fileInput.files.length || !isCSV(fileInput.files[0])) {
        alert("❌ Only CSV files are allowed.");
        return;
      }

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      const html = await fetchWithLoader('/load_csv', {
        method: "POST",
        body: formData
      });

      if (html) {
        document.getElementById("output").innerHTML = html;
        initDataTable();
        toggleImportSidebar();
      }
    }

    async function modalUploadCSV() {
      const fileInput = document.getElementById('importFileInput');
      if (!fileInput.files.length || !isCSV(fileInput.files[0])) {
        alert("❌ Only CSV files are allowed.");
        return;
      }

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      const html = await fetchWithLoader('/load_csv', {
        method: "POST",
        body: formData
      });

      if (html) {
        document.getElementById("output").innerHTML = html;
        initDataTable();
        closeImportModal();
      }
    }

    // Import Sidebar Dropzone
    const importDropzone = document.getElementById("importDropzone");
    const importFile = document.getElementById("importFileInput");
    const importNameDisplay = document.getElementById("importFileNameDisplay");

    if (importDropzone && importFile && importNameDisplay) {
      importDropzone.addEventListener("click", (e) => {
        if (!e.target.closest("button")) importFile.click();
      });

      importDropzone.addEventListener("dragover", e => {
        e.preventDefault();
        importDropzone.classList.add("dragover");
      });

      importDropzone.addEventListener("dragleave", () =>
        importDropzone.classList.remove("dragover")
      );

      importDropzone.addEventListener("drop", e => {
        e.preventDefault();
        importDropzone.classList.remove("dragover");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          importFile.files = files;
          importNameDisplay.textContent = "Selected file: " + files[0].name;
        }
      });

      importFile.addEventListener("change", () => {
        if (importFile.files.length > 0) {
          importNameDisplay.textContent =
            "Selected file: " + importFile.files[0].name;
        }
      });
    }

    // --- TUTORIAL FUNCTIONS ---
    const tutorials = [
      {
        title: "Load CSV Data",
        icon: "bi-upload",
        route: "/load_csv (POST)",
        description: "Upload and load a CSV file into the application for data cleaning operations.",
        usage: "Use the Import Data sidebar or drag & drop a CSV file. The system automatically detects file encoding.",
        features: ["Automatic encoding detection", "CSV file validation", "Clears history when loading new data"],
        note: "Only CSV files are supported. The file must have proper headers."
      },
            {
        title: "Remove Special Characters",
        icon: "bi-slash-circle",
        route: "/remove_special_chars",
        description: "Remove special characters from text columns while preserving basic punctuation.",
        usage: "Click the 'Remove special chars' button to clean text data.",
        features: ["Keeps letters, numbers, spaces", "Preserves - ' , characters", "Applied to all columns"],
        note: "Useful for cleaning data imported from systems that add unwanted symbols."
      },
      {
        title: "Remove Duplicates by Column",
        icon: "bi-layers",
        route: "/remove_duplicates_by_column",
        description: "Remove duplicate rows based on a specific column value.",
        usage: "Enter a column name and click 'Remove duplicates' to eliminate duplicate rows.",
        features: ["Target specific column", "Preserves first occurrence", "Shows affected row count"],
        note: "Make sure to specify the correct column name exactly as it appears in your data."
      },
      {
        title: "Standardize Text",
        icon: "bi-type",
        route: "/standardize_text",
        description: "Convert text columns to title case (first letter capitalized, rest lowercase).",
        usage: "Click 'Standardize text' to apply title case formatting to all text columns.",
        features: ["Title case conversion", "Applied to all string columns", "Preserves non-text data"],
        note: "Perfect for standardizing names, addresses, and other text fields."
      },
      {
        title: "Fix Dates",
        icon: "bi-calendar",
        route: "/fix_dates",
        description: "Automatically detect and standardize date columns to YYYY-MM-DD format.",
        usage: "Click 'Fix dates' to convert various date formats (MM/DD/YYYY, DD-MM-YYYY, etc.) to standard format.",
        features: ["Auto-detects date columns", "Handles multiple date formats", "Converts to YYYY-MM-DD", "Preserves invalid dates"],
        note: "Works on columns containing 'date', 'time', 'join', 'start', 'end' keywords. Invalid dates are left unchanged."
      },
      {
        title: "Drop Missing Values",
        icon: "bi-dash-circle",
        route: "/drop_missing",
        description: "Remove rows that contain any missing (null/NaN) values.",
        usage: "Click 'Drop missing rows' to remove all rows with empty cells.",
        features: ["Removes rows with any null values", "Shows count of removed rows", "Creates history backup"],
        note: "Be careful - this removes entire rows. Consider filling missing values first if needed."
      },
      {
        title: "Fill Missing Values",
        icon: "bi-plus-circle",
        route: "/fill_missing",
        description: "Fill all missing (null/NaN) values with zeros.",
        usage: "Click 'Fill missing with 0' to replace empty cells with zeros.",
        features: ["Fills null values with 0", "Applied to all columns", "Shows count of filled cells"],
        note: "Useful for numeric columns where missing values should be treated as zero."
      },
      {
        title: "Sort Data",
        icon: "bi-sort-down",
        route: "/sort_values",
        description: "Sort the dataset by a specific column in ascending order.",
        usage: "Enter a column name and click 'Sort' to reorder your data.",
        features: ["Ascending order", "Applies to entire dataset", "Creates history backup"],
        note: "The column name must match exactly. Case-sensitive."
      },
      {
        title: "Sort Interface",
        icon: "bi-list-ul",
        route: "/sort_interface",
        description: "Display a dropdown interface to select columns for sorting.",
        usage: "Access through the sorting interface to see available columns and sort.",
        features: ["Dropdown column selection", "Interactive sorting", "Shows current data"],
        note: "Provides a user-friendly way to sort without typing column names."
      },
      {
        title: "Generate Bar Chart",
        icon: "bi-bar-chart",
        route: "/bar_chart",
        description: "Generate a bar chart showing value counts for the first column.",
        usage: "Click to create a bar chart visualization of your first column's data distribution.",
        features: ["Automatic value counting", "PNG image output", "Saved to static folder"],
        note: "Chart shows frequency distribution of values in the first column."
      },
      {
        title: "Generate Pie Chart",
        icon: "bi-pie-chart",
        route: "/pie_chart",
        description: "Generate a pie chart showing percentage distribution for the first column.",
        usage: "Click to create a pie chart visualization of your first column's data distribution.",
        features: ["Percentage calculation", "PNG image output", "Automatic labeling"],
        note: "Best for categorical data with limited unique values."
      },
      {
        title: "Change Data Type",
        icon: "bi-arrow-left-right",
        route: "/change_dtype",
        description: "Convert a column to a different data type (int, float, str, bool, category).",
        usage: "Enter column name, select data type, and click 'Apply' to convert.",
        features: ["Multiple type options", "Error handling", "Type validation"],
        note: "Invalid conversions will show error messages. Make sure data is compatible."
      },
      {
        title: "Replace Values (Normal)",
        icon: "bi-arrow-repeat",
        route: "/replace_values",
        description: "Replace substrings within text values (case-insensitive partial matching).",
        usage: "Enter column, search text, and replacement value. Click 'Replace (normal)'.",
        features: ["Substring replacement", "Case-insensitive", "Partial matching"],
        note: "Use for general text replacements where exact matching isn't required."
      },
      {
        title: "Replace Values (Sensitive)",
        icon: "bi-shield-lock",
        route: "/replace_values_sensitive",
        description: "Replace only exact full-value matches (case-insensitive but precise).",
        usage: "Enter column, exact value to replace, and new value. Click 'Replace (sensitive)'.",
        features: ["Exact value matching", "Case-insensitive", "Full value replacement"],
        note: "Use when you need to replace only complete, exact values."
      },
      {
        title: "Rename Column",
        icon: "bi-input-cursor-text",
        route: "/rename_column",
        description: "Change the name of a column while preserving the data.",
        usage: "Enter current column name and new name, then click 'Rename'.",
        features: ["Preserves data", "Updates column header", "Creates history backup"],
        note: "Column names must be exact. Check spelling and case."
      },
      {
        title: "Undo Last Operation",
        icon: "bi-arrow-counterclockwise",
        route: "/undo_replace",
        description: "Revert the last data modification operation by restoring from history.",
        usage: "Click 'Undo replace' to restore the previous state of your data.",
        features: ["Single-step undo", "History stack", "State restoration"],
        note: "Only undoes the last operation. Cannot undo multiple steps."
      },
      {
        title: "Drop Column",
        icon: "bi-x-octagon",
        route: "/drop_column",
        description: "Remove an entire column from the dataset.",
        usage: "Enter column name and click 'Drop column' to remove it permanently.",
        features: ["Complete column removal", "Creates history backup", "Irreversible without undo"],
        note: "Be careful - this cannot be undone except through the undo function."
      },
      {
        title: "Filter Rows (Drop/Keep)",
        icon: "bi-filter-circle",
        route: "/drop_value",
        description: "Filter rows based on whether they contain specific values in a column.",
        usage: "Enter column, value to find, and choose 'Drop selected' or 'Keep selected'.",
        features: ["Case-insensitive search", "Drop or keep options", "Substring matching"],
        note: "Drop removes matching rows, Keep removes all non-matching rows."
      },
      {
        title: "Data Profile Analysis",
        icon: "bi-bar-chart-line",
        route: "/data_profile",
        description: "Generate a comprehensive quality report of your dataset.",
        usage: "Click 'Data profile' to see statistics about data quality issues.",
        features: ["Missing value counts", "Data validation", "Duplicate detection", "Email/phone validation"],
        note: "Helps identify data quality problems before cleaning."
      },
      {
        title: "Generate Aliases",
        icon: "bi-list-ol",
        route: "/generate_alias",
        description: "Generate sequential alphanumeric IDs for records.",
        usage: "Enter prefix, start number, and column name. Click 'Generate Aliases'.",
        features: ["Custom prefixes", "Zero-padding", "Sequential numbering", "Target column specification"],
        note: "Perfect for creating ID numbers, reference codes, or sequence numbers."
      },
      {
        title: "Find Data",
        icon: "bi-search",
        route: "/find",
        description: "Search for specific text values across the dataset or in specific columns.",
        usage: "Use URL parameters: ?keyword=search_text&column=optional_column",
        features: ["Global or column search", "Case-insensitive", "Returns matching rows"],
        note: "Accessible through the interface or direct URL parameters."
      },
      {
        title: "Magic Clean",
        icon: "bi-stars",
        route: "/magic_clean",
        description: "AI-powered comprehensive data cleaning with multiple transformations.",
        usage: "Click the 'Magic Clean' button for automated cleaning.",
        features: ["Column name standardization", "Email validation", "Numeric conversion", "Date parsing", "Boolean detection"],
        note: "Beta feature that applies multiple cleaning rules automatically."
      },
      {
        title: "Generate Chart Data",
        icon: "bi-graph-up",
        route: "/generate_chart_data",
        description: "Generate JSON data for Chart.js visualizations.",
        usage: "Specify X and Y columns to get formatted chart data.",
        features: ["Chart.js compatibility", "Data aggregation", "JSON output"],
        note: "Used by the chart drawing function for interactive visualizations."
      },
      {
        title: "Export to CSV",
        icon: "bi-download",
        route: "/export_csv",
        description: "Download the current dataset as a CSV file with direct download.",
        usage: "Click 'Export CSV' in the top bar to download cleaned data instantly.",
        features: ["Direct download", "No page navigation", "UTF-8 encoding", "No index column"],
        note: "Exports the current in-memory state. Always export before closing to save your work."
      },
      {
        title: "Subviolation Mapping",
        icon: "bi-diagram-3",
        route: "/upload_mapping_csv & /apply_subviolation_mapping",
        description: "Apply lookup table mappings to translate codes to descriptions.",
        usage: "Upload mapping CSV with 'id' and 'name' columns, then apply to target column.",
        features: ["Code-to-description mapping", "CSV-based lookup", "Target column specification"],
        note: "Mapping file must have 'id' and 'name' columns exactly."
      },
      {
        title: "Edit Table Cells",
        icon: "bi-pencil-square",
        route: "Frontend: makeTableEditable() + /update_cell",
        description: "Edit individual cells directly in the data preview table.",
        usage: "Double-click any cell to edit it inline. Press Enter to save or Escape to cancel.",
        features: ["Inline editing", "Real-time updates", "Visual feedback", "Data validation"],
        note: "Changes are saved immediately to the in-memory dataset. Export to save permanently."
      },
      {
        title: "Reload Data",
        icon: "bi-arrow-clockwise",
        route: "/reload_data",
        description: "Refresh the data preview to show the current state of the dataset.",
        usage: "Click 'Refresh view' to reload and display the latest data after operations.",
        features: ["State synchronization", "Preserves DataTables settings", "Full dataset reload"],
        note: "Useful after background operations or when display seems out of sync."
      },
      // {
      //   title: "Barangay Mapping",
      //   icon: "bi-geo-alt",
      //   route: "/upload_barangay_csv & /apply_barangay_mapping",
      //   description: "Standardize barangay names using official templates.",
      //   usage: "Upload barangay template CSV, then apply mapping to address columns.",
      //   features: ["Template matching", "Parentheses handling", "Case-insensitive matching"],
      //   note: "Fixes common barangay name variations and standardizes formatting."
      // }
    ];

    let currentTutorialIndex = 0;

    function toggleTutorialSidebar() {
      const sidebar = document.getElementById("tutorialSidebar");
      document.body.classList.toggle("sidebar-open");
      sidebar.classList.toggle("open");
      if (sidebar.classList.contains("open")) {
        updateTutorialContent();
      }
    }

    function updateTutorialContent() {
      const tutorial = tutorials[currentTutorialIndex];
      const content = document.getElementById("tutorialContent");
      const counter = document.getElementById("tutorialCounter");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");

      // Update counter
      counter.textContent = `${currentTutorialIndex + 1} / ${tutorials.length}`;

      // Update button states
      prevBtn.disabled = currentTutorialIndex === 0;
      nextBtn.disabled = currentTutorialIndex === tutorials.length - 1;

      // Update content
      content.innerHTML = `
        <div class="tutorial-item">
          <h5 class="text-primary mb-3">
            <i class="bi ${tutorial.icon}"></i> ${tutorial.title}
          </h5>
          <div class="mb-3">
            <strong>Route:</strong> <code>${tutorial.route}</code>
          </div>
          <div class="mb-3">
            <strong>Description:</strong> ${tutorial.description}
          </div>
          <div class="mb-3">
            <strong>Usage:</strong> ${tutorial.usage}
          </div>
          <div class="mb-3">
            <strong>Features:</strong>
            <ul class="list-unstyled ms-3">
              ${tutorial.features.map(feature => `<li>• ${feature}</li>`).join('')}
            </ul>
          </div>
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> ${tutorial.note}
          </div>
        </div>
      `;
    }

    function nextTutorial() {
      if (currentTutorialIndex < tutorials.length - 1) {
        currentTutorialIndex++;
        updateTutorialContent();
      }
    }

    function previousTutorial() {
      if (currentTutorialIndex > 0) {
        currentTutorialIndex--;
        updateTutorialContent();  
      }
    }

  </script>

</body>
</html>